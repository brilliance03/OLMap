<!DOCTYPE html>
<html>
<head lang="zh">
    <meta charset="UTF-8">
    <title>WebGIS</title>
    <link rel="stylesheet" href="../css/ol.css" type="text/css">
    <link rel="stylesheet" href="../css/font-awesome/css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="../css/map.css" type="text/css">
    <link rel="stylesheet" href="../css/jquery.qtip.min.css" type="text/css">
</head>
<body>
<div id="map"></div>
<div id="mapOperationBar" class="ol-unselectable">
    <a href="#" id="mapOperation"><i class="fa fa-globe"></i></a>
</div>
<div style="display: none">
   <fieldset>
        <legend>测量</legend>
       <a href="javascript:;" id="measureDistance">测量距离</a>
       <a href="javascript:;" id="measureArea">测量面积</a>
   </fieldset>
    <p/>
    <fieldset>
        <legend>标绘</legend>
        <a href="javascript:;" id="drawPoint">绘制点</a>
        <a href="javascript:;" id="drawLine">绘制线</a>
        <a href="javascript:;" id="drawCircle">绘制圆</a>
        <a href="javascript:;" id="drawPoly">绘制多边形</a>
    </fieldset>
</div>
<div id="mousePosition" class="ol-unselectable"></div>
<div id="layerGroupMenuBar" class="ol-unselectable">
    <button class="btnLayerChoose" id="btnBaseMap" value="baseMap">行政区划地图</button>
    <button class="btnLayerChoose" id="btnAerialMap" value="aerialMapBing" title="此图层需要互联网连接才可显示">卫星图</button>
    <button class="btnLayerChoose" id="btnAerialLabelMap" value="aerialWithLabelMapBing" title="此图层需要互联网连接才可显示">标注卫星图</button>
</div>
<div id="dataLocateBar" class="ol-unselectable">
    <ul>
        <li><a href="#" class="dropdown" title="提供数据信息的标点定位功能"><span>标点定位</span><i class="fa fa-angle-double-down" style="color: white"></i></a></li>
        <li class="sublinks">
            <a href="#"><i class="fa fa-bullseye"></i><span>灾情标点</span></a>
            <a href="#"><i class="fa fa-home"></i><span>物资库标点</span></a>
            <a href="#"><i class="fa fa-warning"></i><span>地质灾害隐患点标点</span></a>
            <a href="#"><i class="fa fa-group"></i><span>避难场所标点</span></a>
        </li>
    </ul>
</div>
<!--侧边栏-->
<div id="eastnav-left">
    <div class="left-title">
        <div class="left-title-bg" id="zqlb">
            <span class="left-title-icon"><i class="fa fa-bars"></i></span>
            <span class="left-title-word">灾情列表</span>
        </div>
    </div>
    <div class="left-title">
        <div class="left-title-bg" id="zycx">
            <span class="left-title-icon"><i class="fa fa-search"></i></span>
            <span class="left-title-word">资源查询</span>
        </div>
    </div>
    <div class="left-title">
        <div class="left-title-bg" id="jcxx">
            <span class="left-title-icon"><i class="fa fa-info"></i></span>
            <span class="left-title-word">基础信息</span>
        </div>
    </div>
    <div class="left-title">
        <div class="left-title-bg" id="ztt">
            <span class="left-title-icon"><i class="fa fa-picture-o"></i></span>
            <span class="left-title-word">专题图</span>
        </div>
    </div>
    <div id="exit"><i class="fa fa-arrow-right"></i></div>
</div>
<div id="eastnav-right">
    <div class="right-menu" data-url="zqlb">
        <a>灾情列表</a>
    </div>
    <div class="right-menu" data-url="zycx">
        <a>资源查询</a>
    </div>
    <div class="right-menu" data-url="jcxx">
        <a>基础信息</a>
    </div>
    <div class="right-menu" data-url="ztt">
        <a>专题图</a>
    </div>
</div>
<!--鼠标业务菜单-->
<div class="radius"><i class="fa fa-plus"></i></div>
<div class="radius"><i class="fa fa-trash"></i></div>
<div class="radius"><i class="fa fa-globe"></i></div>
<div class="radius"><i class="fa fa-location-arrow"></i></div>
<div class="radius"><i class="fa fa-share"></i></div>

<!--javascript引用-->
<script src="../scripts/ol-debug.js" type="text/javascript"></script>
<script src="../scripts/jquery-1.11.1.min.js" type="text/javascript"></script>
<script src="../scripts/jquery.qtip.min.js" type="text/javascript"></script>
<!--javascript引用 End-->
<script type="text/javascript">
/**********************************************************
 * 定义全局变量
 **********************************************************/
var projection = {}; //定义使用的投影系
var layers = {
    baseLayers: {},
    vectorLayers: {}
} //定义图层集合


/**********************************************************
 * 定义页面控件
 **********************************************************/
//定义比例尺
var scaleLineControl = new ol.control.ScaleLine();
//定义鼠标位置
var mousePositionControl = new ol.control.MousePosition({
    coordinateFormat: ol.coordinate.createStringXY(4),
    projection: 'EPSG:4326',
    target: 'mousePosition',
    undefinedHTML: '暂无坐标'
});
// 滑动设置缩放等级
var zoomslider = new ol.control.ZoomSlider();

/**********************************************************
 * 定义视图
 **********************************************************/
var mapView = new ol.View({
    center: ol.proj.transform([116.42, 39.88], 'EPSG:4326', 'EPSG:3857'),
    zoom: 4,
    minZoom: 2,
    maxZoom: 25
});

/**********************************************************
 * 定义栅格图层
 **********************************************************/
layers.baseLayers.baseMap = new ol.layer.Tile({
    source: new ol.source.XYZ({
        url: 'http://emap{1-3}.mapabc.com/mapabc/maptile?&x={x}&y={y}&z={z}',
        attributions: [
            new ol.Attribution({
                html: '交付中心 © ' +
                        '<a href="http://www.sinosoft.com.cn/">中科软科技股份有限公司</a>'
            })
        ]
    })
}); //定义底图层

layers.baseLayers.aerialMapBing = new ol.layer.Tile({
    //source: new ol.source.MapQuest({layer: 'sat'})
    source: new ol.source.BingMaps({
        culture: 'zh-cn',
        key: 'AhARYbXRzUHxE7zdTbmnZOiHoa_DK6FdOoq1pFbq6MLiA3qOkMALx7YqmVnjqnBs',
        imagerySet: 'Aerial'
    })
}); //定义卫星图层,使用Bing地图

layers.baseLayers.aerialWithLabelMapBing = new ol.layer.Tile({
    //source: new ol.source.MapQuest({layer: 'sat'})
    source: new ol.source.BingMaps({
        culture: 'zh-cn',
        key: 'AhARYbXRzUHxE7zdTbmnZOiHoa_DK6FdOoq1pFbq6MLiA3qOkMALx7YqmVnjqnBs',
        imagerySet: 'AerialWithLabels'
    })
}); //定义带标注的卫星图层,使用Bing地图

var baseMapGroup = new ol.layer.Group({
    layers: [
        layers.baseLayers.baseMap,
        layers.baseLayers.aerialMapBing,
        layers.baseLayers.aerialWithLabelMapBing
    ]
}); //定义底图组，支持切换不同底图

/**********************************************************
 * 定义矢量图层
 **********************************************************/
var styleCache = {};
//显示行政区划边界矢量数据
layers.vectorLayers.provinceBounds = new ol.layer.Vector({
    source: new ol.source.GeoJSON({
        projection: 'EPSG:3857',
        url: 'http://localhost/cgi-bin/mapserv?map=/var/www/cgi-bin/mapserver/mapserver_china.map&service=wfs&request=getfeature&version=1.0.0&maxfeatures=50&typename=provinces_simplify&outputformat=application/json',
    }),
    style: function (feature, resolution) {
        var text = resolution < 5000 ? feature.get('name') : '';
        if (!styleCache[text]) {
            styleCache[text] = [new ol.style.Style({
                fill: new ol.style.Fill({
                    color: 'rgba(255, 255, 255, 0.6)'
                }),
                stroke: new ol.style.Stroke({
                    color: '#319FD3',
                    width: 1
                }),
                text: new ol.style.Text({
                    font: '12px Calibri,sans-serif',
                    text: text,
                    fill: new ol.style.Fill({
                        color: '#000'
                    }),
                    stroke: new ol.style.Stroke({
                        color: '#fff',
                        width: 3
                    })
                })
            })];
        }
        return styleCache[text];
    }
});

//为测量长度和面积准备矢量图层
var source = new ol.source.Vector();

layers.vectorLayers.measureLenAndArea = new ol.layer.Vector({
    source: source,
    style: new ol.style.Style({
        fill: new ol.style.Fill({
            color: 'rgba(255, 255, 255, 0.2)'
        }),
        stroke: new ol.style.Stroke({
            color: '#ffcc33',
            width: 2
        }),
        image: new ol.style.Circle({
            radius: 7,
            fill: new ol.style.Fill({
                color: '#ffcc33'
            })
        })
    })
});

/**********************************************************
 * 定义操作菜单按钮
 **********************************************************/
$('[title!=""]').qtip(); //使用qtip重新渲染所有title提示

//定义图层切换按钮的点击事件
$('#layerGroupMenuBar>button').click(function () {
    var value = this.value;
    for (key in layers.baseLayers) {
        layers.baseLayers[key].setVisible(key == value ? true : false);
    }
    $.each($('#layerGroupMenuBar>button'), function (index, element) {
        changeStyle(element.id, element.value == value ? 'btnLayerChooseAfterClick' : 'btnLayerChoose');
    });
});//设定按钮切换方法

//定义地图操作按钮展开菜单事件
var mapOperObj = $('#mapOperation').qtip({
    content: {
        title: '地图操作按钮',
        text: $('#mapOperation').parent().next(),
        button: 'Close'
    },
    position: {
        my: 'left top',
        adjust: {
            x: 10, y: -12, resize: true
        },
        effect: function(api, pos, viewport) {
            // "this" refers to the tooltip
            $(this).animate(pos, {
                duration: 600,
                easing: 'linear',
                queue: true // Set this to false so it doesn't interfere with the show/hide animations
            });
        }
    },
    style: {
        classes: 'qtip-bootstrap mapOperationPanel'
    },
    show: {
        event: 'click',
        effect: function(offset) {
            $(this).fadeToggle('fast');
        }
    },
    hide: {
        event: 'click'
    }
});

//定义侧边栏菜单展开事件
$('.left-title-bg').click(function () {
    var $this = $(this),
            url = $this.attr('id'),
            $actionmenu = $('.right-menu[data-url = '+ url +']');
    $('#eastnav-left').animate({'right': '260px'}, 300);
    $('#eastnav-right').animate({'right': '1px'}, 300);
    $('.left-title').removeClass('left-title-selected');
    $this.parents('.left-title').addClass('left-title-selected');
    $('.right-menu').hide();
    $actionmenu.fadeIn();
    $('#exit').fadeIn();
});
$('#exit').click(function () {
    $('#eastnav-left').animate({'right': '0px'}, 300);
    $('#eastnav-right').animate({'right': '-260px'}, 300);
    $('.left-title').removeClass('left-title-selected');
    $('.right-menu').hide();
    $('#exit').fadeOut();
});

//定义标点定位按钮展开菜单事件
$('.dropdown').mouseenter(function(){
    $('.sublinks').stop(false, true).hide();

    var submenu = $(this).parent().next();

    submenu.css({
        position:'absolute',
        top: $(this).offset().top + $(this).height() + 'px',
        //left: $(this).offset().left + 'px',
        zIndex:1000
    });

    submenu.stop().slideDown(300);

    submenu.mouseleave(function(){
        $(this).slideUp(300);
    });

    submenu.blur(function(){
        $(this).slideUp(300);
    });
});

/**********************************************************
 * 定义测量长度和面积的方法 example from measure.js
 * on openlayers.org
 **********************************************************/
/**
 * Currently drawed feature
 * @type {ol.Feature}
 */
var sketch;

/**
 * Element for currently drawed feature
 * @type {Element}
 */
var sketchElement;
/**
 * handle pointer move
 * @param {Event} evt
 */
var mouseMoveHandler = function(evt) {
    if (sketch) {
        var output;
        var geom = (sketch.getGeometry());
        if (geom instanceof ol.geom.Polygon) {
            output = formatArea(/** @type {ol.geom.Polygon} */ (geom));

        } else if (geom instanceof ol.geom.LineString) {
            output = formatLength( /** @type {ol.geom.LineString} */ (geom));
        }
        sketchElement.innerHTML = output;
    }
};

/**********************************************************
 * 合成地图、初始化操作
 **********************************************************/
var map = new ol.Map({
    controls: ol.control.defaults({
        attributionOptions: ({
            collapsible: true
        })
    }).extend([
        zoomslider,
        scaleLineControl,
        mousePositionControl
    ]),
    layers: [
        baseMapGroup,
        layers.vectorLayers.provinceBounds
    ],
    view: mapView,
    target: 'map'
});

$.each($('button.btnLayerChoose'), function () {
    if (this.value == 'baseMap') {
        this.click();
    }
})//图层选择按钮初始化设定，默认显示行政区划地图

layers.vectorLayers.provinceBounds.setVisible(false); //默认不显示矢量图层

//http://localhost/cgi-bin/mapserv?map=/var/www/cgi-bin/mapserver/mapserver_china.map&service=wfs&request=getfeature&version=1.0.0&maxfeatures=50&typename=provinces_simplify&outputformat=application/json

/**********************************************************
 * 绑定鼠标业务菜单操作，默认为浏览模式
 **********************************************************/
/*$('#map').click(function (e) {
    var $items = $('.radius');
    $items.removeClass('radius-scale');
    setTimeout(function () {
        showItem($items, 0, e);
    }, 200)

});*/

$('.radius').click(function (e) {
    e.stopPropagation();
});

function showItem($items, index, e) {
    var x = e.clientX,
            y = e.clientY,
            left,
            top,
            taskId;
    switch (index) {
        case 0:
            left = x - 75;
            top = y - 15;
            break;
        case 1:
            left = x - 58;
            top = y - 57;
            break;
        case 2:
            left = x - 15;
            top = y - 75;
            break;
        case 3:
            left = x + 28;
            top = y - 57;
            break;
        case 4:
            left = x + 45;
            top = y - 15;
            break;
    }

    $($items.get(index)).css({
        'left': left,
        'top': top
    }).addClass('radius-scale');

    if (index < $items.length - 1) {
        taskId = setTimeout(function () {
            showItem($items, ++index, e)
        }, 50);
    }
}

/**********************************************************
 * 公共方法
 **********************************************************/
function changeStyle(domId, styleName) {
    $("#" + domId).removeClass();
    $("#" + domId).addClass(styleName);
}


/**********************************************************
 * 矢量图层操作
 **********************************************************/
var highlightStyleCache = {};

var featureOverlay = new ol.FeatureOverlay({
    map: map,
    style: function (feature, resolution) {
        var text = resolution < 5000 ? feature.get('name') : '';
        if (!highlightStyleCache[text]) {
            highlightStyleCache[text] = [new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: '#f00',
                    width: 1
                }),
                fill: new ol.style.Fill({
                    color: 'rgba(255,0,0,0.1)'
                }),
                text: new ol.style.Text({
                    font: '12px Calibri,sans-serif',
                    text: text,
                    fill: new ol.style.Fill({
                        color: '#000'
                    }),
                    stroke: new ol.style.Stroke({
                        color: '#f00',
                        width: 3
                    })
                })
            })];
        }
        return highlightStyleCache[text];
    }
});

var highlight;
var displayFeatureInfo = function (pixel) {

    var feature = map.forEachFeatureAtPixel(pixel, function (feature, layer) {
        return feature;
    });

    if (feature) {
        //alert(feature.get('Area') + ': ' + feature.get('Name_CHN'));
    }

    if (feature !== highlight) {
        if (highlight) {
            featureOverlay.removeFeature(highlight);
        }
        if (feature) {
            featureOverlay.addFeature(feature);
        }
        highlight = feature;
    }

};

$(map.getViewport()).on('mousemove', function (evt) {
    var pixel = map.getEventPixel(evt.originalEvent);
    displayFeatureInfo(pixel);
});

map.on('click', function (evt) {
    displayFeatureInfo(evt.pixel);
});

</script>
</body>
</html>
